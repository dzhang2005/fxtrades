<!DOCTYPE html>
<html lang="en">
<head>
<title>Prototype Page</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<script type="text/javascript" src="angular.js"></script>
<script type="text/javascript" src=angular-animate.js></script>
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/fxtr.css" />
<script src="jquery-2.2.3.js"></script>
<script type="text/javascript" src="jquery.blockUI.js"></script>
<script src="bootstrap.js"></script>
<script src="ui-bootstrap-tpls-1.3.2.js"></script>
<script src="mask.js"></script>
<script src="modernizr.js"></script>

<link rel="stylesheet" href="css/second.css">
</head>
<body class="container" ng-app="myApp" ng-controller="myCtrl">
	<div class="navbar-brand" style="display: inherit;">
	<a><img class="myLogo" src="images/app_icon.png"/></a></div>
	<div class="page-header">
		<div>
			<h2>Trade Signal</h2>
		</div>
		<div class="text-right">Last refresh time: {{signalRetrieveTime
			| date: 'MM/dd/yyyy hh:mma'}}</div>
	</div>
	<div class="table-responsive">
		<table class="table table-bordered table-hover">
			<tr>
				<td>Side</td>
				<td>Symbol</td>
				<td>Entry Price</td>
				<td>Create Date</td>
				<td>Last Price</td>
				<td class="class-red">Profit</td>
				<td>Nick Name</td>
			</tr>
			<tr ng-repeat-start="signal in signalList">
				<td><input type="hidden" id="tradeId{{$index}}" name="tradeIds" /><span
					ng-class="signal.side">{{signal.side}}</span></td>
				<td>{{signal.symbol}}</td>
				<td>{{signal.entryPrice}}</td>
				<td>{{signal.createDate | date : 'MM/dd/yyyy hh:mma' }}</td>
				<td>{{signal.lastPrice}}<span
 					ng-show="signal.priceChange > 0"
					class="glyphicon glyphicon-arrow-up" style="color: green; transition: all linear 0.5" ></span>
					<span ng-show="signal.priceChange < 0"
					class="glyphicon glyphicon-arrow-down" style="color: red" ></span>
				</td>
				<td>{{signal.profit}}</td>
				<td>{{signal.userNickName}}</td>
			</tr>

			<tr ng-repeat-end>
				<td colspan="7"><img alt="Trend image"
					ng-src="{{signal.chart}}" width="100%"></td>
			</tr>
		</table>
	</div>


	<script>
		angular
				.module('myApp', [])
				.config(
						function($httpProvider) {
							delete $httpProvider.defaults.headers.common['X-Requested-With'];
						})
				.factory(
						'myService',
						function($http) {
							return {
								latestRetrieveTime : function() {
									return new Date();
								},
								latestRetrieveList : $http
										.get(
												"http://www.wuzhenweb.com:8089/json?operation=getfxtrades")
										.then(function(response) {
											return response.data.content;
										}, function(reason) {
											console.log(reason);
											return null;
										}, function(value) {
											console.log(value);
											return null;
										})
							}
						})
				.controller(
						'myCtrl',
						function($scope, $http, $interval, myService) {
							$scope.retrieveOldValue = function(tradeId) {
								if (!$scope.oldSignalList) {
									return null;
								}
								return $scope.oldSignalList.filter(function(
										signal) {
									return signal.tradeId == tradeId;
								});
							};
							$scope.signalRetrieveTime = myService
									.latestRetrieveTime();
							myService.latestRetrieveList.then(function(d) {
								$scope.signalList = d;
							});
							$interval(function() {
								$http
								.get(
										"http://localhost:8089/json?operation=getfxtrades")
								.then(function(response) {
									$scope.newSignalList = response.data.content;
									if ($scope.newSignalList && !$scope.$$parse) {
										$scope.oldSignalList = $scope.signalList;
										$scope.signalList = $scope.newSignalList;
										$scope.signalRetrieveTime = myService
												.latestRetrieveTime();
										$scope.$apply();
									}
								}, function(reason) {
									console.log(reason);
									return null;
								}, function(value) {
									console.log(value);
									return null;
								});
							}, 60000);
						})
				.filter(
						'customArray',
						function($filter) {
							return function(list, arrayFilter, element) {
								if (arrayFilter) {
									return $filter("filter")
											(
													list,
													function(listItem) {
														return arrayFilter
																.indexOf(listItem[element]) != -1;
													});
								}
							};
						});
	</script>
</body>
</html>
